#!/bin/bash
# ==============================================================================
# Pre-commit Hook - Pocket Arbiter
# ==============================================================================
# Enforcement ISO : v√©rifie la conformit√© avant chaque commit
# Installation : git config core.hooksPath .githooks
# ==============================================================================

set -e

echo "üîç ISO Pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

# ==============================================================================
# Check 1: No critical TODO/FIXME
# ==============================================================================
echo -n "  ‚îú‚îÄ Checking for critical TODO/FIXME... "

CRITICAL_PATTERNS="TODO.*CRITICAL\|FIXME.*CRITICAL\|TODO.*URGENT\|FIXME.*URGENT\|XXX"
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(kt|py|java|js|ts)$' || true)

if [ -n "$STAGED_FILES" ]; then
    FOUND=$(echo "$STAGED_FILES" | xargs grep -l "$CRITICAL_PATTERNS" 2>/dev/null || true)
    if [ -n "$FOUND" ]; then
        echo -e "${RED}FAILED${NC}"
        echo "    Critical TODO/FIXME found in:"
        echo "$FOUND" | sed 's/^/      - /'
        ERRORS=$((ERRORS + 1))
    else
        echo -e "${GREEN}OK${NC}"
    fi
else
    echo -e "${GREEN}OK${NC} (no code files)"
fi

# ==============================================================================
# Check 2: No secrets/credentials
# ==============================================================================
echo -n "  ‚îú‚îÄ Checking for secrets... "

SECRET_PATTERNS="password\s*=\s*[\"'][^\"']+[\"']\|api_key\s*=\s*[\"'][^\"']+[\"']\|secret\s*=\s*[\"'][^\"']+[\"']\|token\s*=\s*[\"'][A-Za-z0-9]"

if [ -n "$STAGED_FILES" ]; then
    FOUND=$(echo "$STAGED_FILES" | xargs grep -il "$SECRET_PATTERNS" 2>/dev/null || true)
    if [ -n "$FOUND" ]; then
        echo -e "${RED}FAILED${NC}"
        echo "    Potential secrets found in:"
        echo "$FOUND" | sed 's/^/      - /'
        ERRORS=$((ERRORS + 1))
    else
        echo -e "${GREEN}OK${NC}"
    fi
else
    echo -e "${GREEN}OK${NC}"
fi

# ==============================================================================
# Check 3: Python lint (if Python files staged)
# ==============================================================================
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)

if [ -n "$PYTHON_FILES" ]; then
    echo -n "  ‚îú‚îÄ Python lint (flake8)... "
    if command -v flake8 &> /dev/null; then
        if echo "$PYTHON_FILES" | xargs flake8 --max-line-length=100 --ignore=E501,W503 2>/dev/null; then
            echo -e "${GREEN}OK${NC}"
        else
            echo -e "${YELLOW}WARNINGS${NC} (non-blocking)"
        fi
    else
        echo -e "${YELLOW}SKIPPED${NC} (flake8 not installed)"
    fi
fi

# ==============================================================================
# Check 4: JSON validity
# ==============================================================================
JSON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.json$' || true)

if [ -n "$JSON_FILES" ]; then
    echo -n "  ‚îú‚îÄ JSON validity... "
    JSON_ERRORS=0
    for f in $JSON_FILES; do
        if [ -f "$f" ]; then
            if ! python -c "import json; json.load(open('$f', encoding='utf-8'))" 2>/dev/null; then
                echo ""
                echo "      Invalid JSON: $f"
                JSON_ERRORS=$((JSON_ERRORS + 1))
            fi
        fi
    done
    if [ $JSON_ERRORS -eq 0 ]; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAILED${NC}"
        ERRORS=$((ERRORS + 1))
    fi
fi

# ==============================================================================
# Check 5: ISO docs exist
# ==============================================================================
echo -n "  ‚îú‚îÄ ISO documentation... "

ISO_DOCS="docs/VISION.md docs/AI_POLICY.md docs/QUALITY_REQUIREMENTS.md docs/TEST_PLAN.md"
MISSING_DOCS=""

for doc in $ISO_DOCS; do
    if [ ! -f "$doc" ]; then
        MISSING_DOCS="$MISSING_DOCS $doc"
    fi
done

if [ -z "$MISSING_DOCS" ]; then
    echo -e "${GREEN}OK${NC}"
else
    echo -e "${RED}FAILED${NC}"
    echo "    Missing ISO docs:$MISSING_DOCS"
    ERRORS=$((ERRORS + 1))
fi

# ==============================================================================
# Check 6: No hallucination-prone patterns in AI code
# ==============================================================================
echo -n "  ‚îî‚îÄ AI safety patterns... "

AI_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(llm|ai|prompt|generat)' || true)
UNSAFE_PATTERNS="generate.*without.*context\|response.*without.*source\|no.*citation"

if [ -n "$AI_FILES" ]; then
    FOUND=$(echo "$AI_FILES" | xargs grep -il "$UNSAFE_PATTERNS" 2>/dev/null || true)
    if [ -n "$FOUND" ]; then
        echo -e "${YELLOW}WARNING${NC}"
        echo "    Potential AI safety issue in:"
        echo "$FOUND" | sed 's/^/      - /'
    else
        echo -e "${GREEN}OK${NC}"
    fi
else
    echo -e "${GREEN}OK${NC}"
fi

# ==============================================================================
# Final result
# ==============================================================================
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}‚ùå Pre-commit failed with $ERRORS error(s)${NC}"
    echo "   Fix the issues above before committing."
    exit 1
else
    echo -e "${GREEN}‚úÖ All ISO pre-commit checks passed${NC}"
    exit 0
fi
