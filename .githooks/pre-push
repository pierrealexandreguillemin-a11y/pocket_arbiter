#!/bin/sh
# ISO 12207: Pre-push hook - BLOCKING
# Prevents dangerous operations on protected branches

# Protected branches
PROTECTED="main master"

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Get remote and URL from arguments
REMOTE="$1"
URL="$2"

echo "ISO Pre-push validation..."
echo "=================================================="

# Check for force push
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # Deleting branch - allow
        continue
    fi

    # Check if this is a force push (non-fast-forward)
    if [ "$remote_sha" != "0000000000000000000000000000000000000000" ]; then
        # Remote exists, check if we're force pushing
        if ! git merge-base --is-ancestor "$remote_sha" "$local_sha" 2>/dev/null; then
            for protected in $PROTECTED; do
                if echo "$remote_ref" | grep -q "refs/heads/$protected"; then
                    echo "  [BLOCKED] Force push to $protected is FORBIDDEN"
                    echo "=================================================="
                    exit 1
                fi
            done
        fi
    fi
done

echo "  [OK] Push validation passed"
echo "=================================================="
exit 0
