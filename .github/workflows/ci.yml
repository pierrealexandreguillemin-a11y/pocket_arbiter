# ==============================================================================
# CI/CD Pipeline - Pocket Arbiter
# ==============================================================================
# ISO/IEC 29119 compliant - ALL CHECKS ARE BLOCKING
# No || true, no continue-on-error (except where explicitly justified)
# ==============================================================================

name: CI - Pocket Arbiter (ISO Strict)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  JAVA_VERSION: '17'

jobs:
  # ============================================================================
  # Job 1: ISO Validation (BLOCKING GATE)
  # ============================================================================
  iso-validation:
    name: ISO Validation Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run ISO Validator
        run: python scripts/iso/validate_project.py

      - name: Verify ISO Documentation (BLOCKING)
        run: |
          echo "=== ISO Documentation Check ==="
          MISSING=0

          for doc in docs/VISION.md docs/AI_POLICY.md docs/QUALITY_REQUIREMENTS.md docs/TEST_PLAN.md; do
            if [ -f "$doc" ]; then
              echo "[OK] $doc"
            else
              echo "[FAIL] $doc MISSING"
              MISSING=$((MISSING + 1))
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo ""
            echo "BLOCKED: $MISSING ISO document(s) missing"
            exit 1
          fi

      - name: Verify ISO 42001 AI Policy (BLOCKING)
        run: |
          echo "=== ISO 42001 - AI Governance ==="

          # AI Policy must exist
          if [ ! -f "docs/AI_POLICY.md" ]; then
            echo "[FAIL] AI_POLICY.md missing"
            exit 1
          fi
          echo "[OK] AI Policy exists"

          # Prompts must be versioned
          if [ ! -f "prompts/CHANGELOG.md" ]; then
            echo "[FAIL] prompts/CHANGELOG.md missing"
            exit 1
          fi
          echo "[OK] Prompts versioned"

          # No dangerous AI patterns (exclude validator itself)
          echo "Checking AI safety patterns..."
          if grep -r --include="*.py" --include="*.kt" \
            -E "generate_without_context|skip_citation|no_source_check" \
            scripts/ android/ 2>/dev/null | grep -v "validate_project.py" | grep -v "pre-commit.py"; then
            echo "[FAIL] Dangerous AI patterns found"
            exit 1
          fi
          echo "[OK] No dangerous AI patterns"

      - name: Verify Project Structure (BLOCKING)
        run: |
          echo "=== Project Structure ==="
          MISSING=0

          for dir in scripts corpus docs prompts tests .iso .githooks; do
            if [ -d "$dir" ]; then
              echo "[OK] $dir/"
            else
              echo "[FAIL] $dir/ MISSING"
              MISSING=$((MISSING + 1))
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo "BLOCKED: $MISSING required directory(ies) missing"
            exit 1
          fi

  # ============================================================================
  # Job 2: Test Data Validation (BLOCKING)
  # ============================================================================
  validate-test-data:
    name: Test Data Validation
    runs-on: ubuntu-latest
    needs: [iso-validation]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate JSON Test Files (BLOCKING)
        run: |
          echo "=== JSON Validation ==="
          python3 << 'EOF'
          import json
          import sys
          from pathlib import Path

          test_files = [
              'tests/data/questions_fr.json',
              'tests/data/questions_intl.json',
              'tests/data/adversarial.json',
              '.iso/config.json',
          ]

          errors = 0
          for f in test_files:
              p = Path(f)
              if not p.exists():
                  print(f"[FAIL] {f} - File not found")
                  errors += 1
                  continue
              try:
                  with open(p, 'r', encoding='utf-8') as fp:
                      data = json.load(fp)
                  count = len(data) if isinstance(data, list) else 'object'
                  print(f"[OK] {f} - Valid ({count})")
              except json.JSONDecodeError as e:
                  print(f"[FAIL] {f} - Invalid JSON: {e}")
                  errors += 1

          if errors > 0:
              print(f"\nBLOCKED: {errors} JSON file(s) invalid")
              sys.exit(1)
          EOF

      - name: Verify Corpus Inventory (BLOCKING)
        run: |
          if [ ! -f "corpus/INVENTORY.md" ]; then
            echo "[FAIL] corpus/INVENTORY.md missing"
            exit 1
          fi
          echo "[OK] Corpus inventory exists"

          # Count PDFs
          PDF_COUNT=$(find corpus -name "*.pdf" 2>/dev/null | wc -l)
          echo "[INFO] Found $PDF_COUNT PDF files"

          if [ "$PDF_COUNT" -eq 0 ]; then
            echo "[WARN] No PDF files in corpus (expected for CI without LFS)"
          fi

  # ============================================================================
  # Job 3: Python Quality (BLOCKING)
  # ============================================================================
  python-quality:
    name: Python Quality
    runs-on: ubuntu-latest
    needs: [iso-validation]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'scripts/requirements.txt'

      - name: Install Dependencies (BLOCKING)
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest pytest-cov
          # Install test dependencies - minimal set for CI
          pip install tiktoken tqdm

      - name: Lint Python (BLOCKING - errors only)
        run: |
          echo "=== Python Lint ==="
          # E9: Runtime errors (syntax, etc)
          # F63: Invalid syntax in type comments
          # F7: Syntax errors
          # F82: Undefined names
          flake8 scripts/ --select=E9,F63,F7,F82 --show-source --statistics
          echo "[OK] No critical Python errors"

      - name: Python Syntax Check (BLOCKING)
        run: |
          echo "=== Python Syntax ==="
          python3 << 'EOF'
          import sys
          import py_compile
          from pathlib import Path

          errors = 0
          for f in Path('scripts').rglob('*.py'):
              try:
                  py_compile.compile(str(f), doraise=True)
                  print(f"[OK] {f}")
              except py_compile.PyCompileError as e:
                  print(f"[FAIL] {f}: {e}")
                  errors += 1

          if errors > 0:
              print(f"\nBLOCKED: {errors} Python file(s) have syntax errors")
              sys.exit(1)
          EOF

      - name: Run ISO Validator Tests
        run: |
          echo "=== ISO Validator Self-Test ==="
          python scripts/iso/validate_project.py --verbose

      - name: Run Unit Tests (BLOCKING)
        run: |
          echo "=== Unit Tests ==="
          pytest scripts/iso/test_validator.py -v --tb=short
          echo "[OK] All unit tests passed"

      - name: Run Tests with Coverage (BLOCKING)
        run: |
          echo "=== Coverage Report ==="
          pytest scripts/iso/ --cov=scripts/iso --cov-report=term-missing --cov-fail-under=60
          echo "[OK] Coverage meets minimum threshold (60%)"

  # ============================================================================
  # Job 4: Documentation Quality
  # ============================================================================
  docs-quality:
    name: Documentation Quality
    runs-on: ubuntu-latest
    needs: [iso-validation]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Required Documentation (BLOCKING)
        run: |
          echo "=== Documentation Check ==="
          ERRORS=0

          # Check all required docs exist and are not empty
          for doc in README.md CLAUDE_CODE_INSTRUCTIONS.md docs/VISION.md docs/AI_POLICY.md docs/QUALITY_REQUIREMENTS.md docs/TEST_PLAN.md; do
            if [ -f "$doc" ]; then
              LINES=$(wc -l < "$doc")
              if [ "$LINES" -lt 10 ]; then
                echo "[WARN] $doc is very short ($LINES lines)"
              else
                echo "[OK] $doc ($LINES lines)"
              fi
            else
              echo "[FAIL] $doc MISSING"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo "BLOCKED: $ERRORS required document(s) missing"
            exit 1
          fi

      - name: Generate Metrics Report
        run: |
          echo "=== Project Metrics ==="
          echo "Commits: $(git rev-list --count HEAD)"
          echo "Files: $(find . -type f -not -path './.git/*' | wc -l)"
          echo "Python files: $(find . -name '*.py' -not -path './.git/*' | wc -l)"
          echo "Documentation: $(find docs -name '*.md' | wc -l) files"
          echo "Test data: $(find tests/data -name '*.json' 2>/dev/null | wc -l) files"
          echo "PDF corpus: $(find corpus -name '*.pdf' 2>/dev/null | wc -l) files"

  # ============================================================================
  # Job 5: Build Android (manual/tag only - NOT blocking for now)
  # ============================================================================
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: [python-quality, docs-quality, validate-test-data]
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          android: false
          tool-cache: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Check Android Project
        run: |
          if [ ! -f "android/gradlew" ]; then
            echo "[INFO] Android project not initialized yet"
            echo "This is expected in Phase 0-1"
            exit 0
          fi

      - name: Build APK
        if: hashFiles('android/gradlew') != ''
        working-directory: android
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug --stacktrace

      - name: Upload APK
        if: hashFiles('android/app/build/outputs/apk/debug/*.apk') != ''
        uses: actions/upload-artifact@v4
        with:
          name: apk-debug-${{ github.sha }}
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 14
